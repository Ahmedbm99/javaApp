- hosts: app_servers
  become: yes
  vars:
    registry_url: "192.168.220.8:5000"
    registry_username: "{{ registry_username }}"
    registry_password: "{{ registry_password }}"
    image: "{{ image }}"
    app_name: "app"
    app_port: 3000
    backup_dir: "/home/server/docker-backups"

  tasks:
    - name: Ensure backup directory exists
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Check registry connectivity
      shell: docker login {{ registry_url }} -u {{ registry_username }} -p {{ registry_password }}
      register: login_result
      ignore_errors: yes

    - name: Pull image from registry or use backup
      block:
        - name: Pull image from registry
          shell: docker pull "{{ image }}"
          when: login_result.rc == 0

        - name: Load latest backup image
          shell: docker load -i $(ls -t {{ backup_dir }}/*.tar | head -1)
          when: login_result.rc != 0

    - name: Save current image as backup
      shell: |
        if docker inspect --type=image "{{ image }}" >/dev/null 2>&1; then
          docker save -o {{ backup_dir }}/{{ app_name }}_{{ ansible_date_time.iso8601 }}.tar {{ image }}
        fi
      ignore_errors: yes

    - name: Stop container if running
      shell: |
        if docker ps -q -f name={{ app_name }} >/dev/null; then
          docker stop {{ app_name }}
        fi
      ignore_errors: yes

    - name: Remove container if exists
      shell: |
        if docker ps -aq -f name={{ app_name }} >/dev/null; then
          docker rm -f {{ app_name }}
        fi
      ignore_errors: yes

    - name: Prune stopped containers
      shell: docker container prune -f
      ignore_errors: yes

    - name: Run container
      shell: docker run -d --name {{ app_name }} -p {{ app_port }}:{{ app_port }} "{{ image }}"
      register: run_result
      ignore_errors: yes

    - name: Rollback if container failed to start
      shell: |
        echo "Container failed to start, loading last backup..."
        docker load -i $(ls -t {{ backup_dir }}/*.tar | head -1)
        docker run -d --name {{ app_name }} -p {{ app_port }}:{{ app_port }} "{{ image }}"
      when: run_result.rc != 0
