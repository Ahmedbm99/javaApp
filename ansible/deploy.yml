- hosts: app_servers
  become: yes
  vars:
    registry_url: "192.168.220.8:5000"
    registry_username: "{{ registry_username }}"
    registry_password: "{{ registry_password }}"
    image: "{{ image }}"

  tasks:
    - name: Login to Docker registry
      shell: echo "{{ registry_password }}" | docker login {{ registry_url }} -u "{{ registry_username }}" --password-stdin

    - name: Ensure app directory exists
      file:
        path: /app/target/docker_images_backup
        state: directory
        mode: '0755'

    - name: Save current image before update
      shell: docker inspect --format='{{'{{'}}.Config.Image{{'}}'}}' app > /app/target/docker_images_backup/prev_image
      ignore_errors: yes

    - name: Pull docker image
      shell: docker pull "{{ image }}"

    # Force stop if running
    - name: Force stop container if exists
      shell: docker stop app 

    # Force remove if exists (avoids name conflict)
    - name: Force remove container if exists
      shell: docker rm -f app 

    # Optional but safer
    - name: Prune stopped containers
      shell: docker container prune -f

    - name: Run container
      shell: docker run -d --name app -p 3000:3000 "{{ image }}"
