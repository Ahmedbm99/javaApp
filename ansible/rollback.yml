    - name: Rollback deployment
      hosts: app_servers
      become: yes
      vars:
        backup_dir: /home/server/docker-backups
      tasks:
    
    # ----------------------------
    # Find last backup file
    # ----------------------------
    - name: Get last backup file
      shell: ls -t {{ backup_dir }}/*.tar | head -1
      register: last_backup
      failed_when: last_backup.stdout == ""
      ignore_errors: no

    - name: Show last backup file
      debug:
        msg: "Last backup file: {{ last_backup.stdout }}"

    # ----------------------------
    # Load backup image
    # ----------------------------
    - name: Load backup image
      shell: docker load -i {{ last_backup.stdout }}
      register: loaded_image

    - name: Show loaded image result
      debug:
        msg: "{{ loaded_image.stdout }}"

    # ----------------------------
    # Extract image name from load output
    # ----------------------------
    - name: Extract image full name
      set_fact:
        backup_image: "{{ loaded_image.stdout | regex_search('Loaded image: (.*)', '\\1') }}"

    - name: Show extracted image name
      debug:
        var: backup_image

    # ----------------------------
    # Stop & remove current container
    # ----------------------------
    - name: Stop current container
      shell: docker stop app
      ignore_errors: yes

    - name: Remove current container
      shell: docker rm -f app
      ignore_errors: yes

    # ----------------------------
    # Run container from backup image
    # ----------------------------
    - name: Start container using backup image
      shell: docker run -d --name app -p 3000:3000 {{ backup_image }}
