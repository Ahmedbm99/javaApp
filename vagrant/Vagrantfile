Vagrant.configure("2") do |config|

  config.vm.box = "ubuntu/focal64"
  config.vm.hostname = "app-server"
  config.vm.network "public_network",bridge: "VirtualBox Host-Only Ethernet Adapter #2" ,  ip: "192.168.220.9"

  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end

  config.vm.provision "shell", inline: <<-SHELL
    apt update -y

    # Install Docker
    apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
    add-apt-repository \
      "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
    apt update -y
    apt install -y docker-ce docker-ce-cli containerd.io
    usermod -aG docker vagrant

    # Install PostgreSQL
    apt install -y postgresql postgresql-contrib
    sudo -u postgres psql -c "CREATE USER admin WITH PASSWORD 'admin';"
    sudo -u postgres psql -c "CREATE DATABASE appdb OWNER admin;"

    # Install Flyway
    wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.16.3/flyway-commandline-9.16.3-linux-x64.tar.gz \
      | tar xvz -C /opt
    ln -s /opt/flyway-9.16.3/flyway /usr/local/bin/flyway

    mkdir -p /var/lib/my-app
    mkdir -p /home/vagrant/migrations
  SHELL
end
